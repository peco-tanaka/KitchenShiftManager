# 勤怠管理システム 要件定義（Rev 2.0 / 2025‑06‑04）



## 1. 目的・背景

| 項目   | 内容                                        |
| ---- | ----------------------------------------- |
| 導入背景 | タイムカード＋手入力 Excel で月末 2 日掛かっていた集計業務をゼロにする。 |
| 改善指標 | 月末作業 0 日・打刻漏れ率 1 % 未満（任意）。                |
| 想定規模 | 従業員 ≈ 50 名・1〜複数店舗（飲食）。                    |
| 使用端末 | **PC（メイン）／共有タブレット**。スマホとオフライン打刻は対象外。      |



## 2. ステークホルダー & RBAC

| ロール         | 主タスク                             |
| ----------- | -------------------------------- |
| **Staff**   | 出退勤打刻（外出／戻り含む）。自己修正申請は実装しない。     |
| **Manager** | シフト入力、勤怠編集／承認、ユーザ管理、月次 Excel 出力。 |



## 3. システム全体構成

```
┌─────────────┐           ┌──────────────────┐
│  React SPA      │  HTTPS   │  Rails API (Render) │
│  (Vite + TS)    │◀──────▶│  PostgreSQL (Render) │
│  Cloudflare Pages│         │  Excel 出力 API     │
└─────────────┘           └──────────────────┘
```

* **フロント**：React + TypeScript（Vite）を SPA としてビルド→ Cloudflare Pages のエッジ CDN で配信（無料枠）。
* **バックエンド**：Rails 7 `--api` モード。JSON を返す REST API。Render Standard Container (US /EU)。
* **DB**：Render Managed PostgreSQL Starter。日次＋PITR 7 日、週次 `pg_dump` を GitHub Private 保存。
* **認証**：Devise Token Auth + JWT。発行トークンを **httpOnly Cookie** に格納し XSS を緩和。
* **通信**：Rails 側 `rack-cors` で `Access‑Control‑Allow‑Origin: https://*.pages.dev` を許可。



## 4. 機能要件（MVP）

| #   | 機能                  | 詳細                                                                                                 |
| --- | ------------------- | -------------------------------------------------------------------------------------------------- |
| 4‑1 | **打刻**              | 4 桁社員番号＋PW でログイン → ボタン *出勤 / 退勤 / 外出 / 戻り* を登録 (`time_cards` テーブル)。                                |
| 4‑2 | **勤怠一覧 (Web テーブル)** | React で AG‑Grid／Tabulator を使用。インライン編集→`PATCH /time_cards/:id`。編集時 `change_logs` に before/after 保持。 |
| 4‑3 | **シフト入力**           | テーブル画面で直接入力 or Excel アップロード (`/shifts/import`)。社員番号＋日付キーで upsert。                                  |
| 4‑4 | **月次 Excel 出力**     | フロントの “DL” ボタン → `GET /reports/:yyyy‑mm`。Rails で `axlsx_rails` テンプレを合成しストリーム返却。サーバ保存なし。            |
| 4‑5 | **ユーザ管理**           | `/users` CRUD。パスワードは bcrypt(12)。                                                                   |

### スコープ外

* 給与計算ロジック（Excel 内関数に委任）。
* メール／Slack 通知、スマホ／オフライン打刻、ファイル画像保存。


## 5. 非機能要件

| 分類      | 要件                                                                         |
| ------- | -------------------------------------------------------------------------- |
| パフォーマンス | 端末 2 台程度での打刻を想定。API レスポンスは < 300 ms を目指す。                                  |
| 可用性     | 稼働率 99 %（6 :00–25 :00）。                                                    |
| セキュリティ  | HTTPS/TLS1.2＋、JWT httpOnly Cookie、bcrypt 12、Pundit Policy、ログ 3 年保存 (APPI)。 |
| コスト上限   | Render (¥1,100×2) ≒ ¥2,200 + Cloudflare Pages ¥0 → **月 ≤ ¥3,000**。         |
| 監査      | `change_logs` テーブル（user\_id, before, after, ip, time）を 3 年保存。              |



## 6. 開発 & デプロイ

| 項目           | フロント (SPA)                                                                                                    | バックエンド (API)                                |
| ------------ | ------------------------------------------------------------------------------------------------------------- | ------------------------------------------- |
| **ビルドツール**   | Vite + TypeScript                                                                                             | Rails 7 (API)                               |
| **スタイリング方針** | **Phase 1:** 素の CSS (CSS Modules or scoped styles)<br>**Phase 2:** Tailwind CSS を導入して UI 改修（PostCSS プラグインで追加） | --                                          |
| CI/CD        | GitHub → Cloudflare Pages Auto Deploy                                                                         | GitHub → Render Auto Deploy                 |
| ローカル開発       | `vite dev` (`http://localhost:5173`)                                                                          | `rails s -p 3000` (`http://localhost:3000`) |
| 型共有          | `openapi-typescript` で API Schema → `src/types/api.d.ts` 自動生成                                                 | --                                          |
| テスト          | React Testing Library / Jest                                                                                  | RSpec / FactoryBot                          |
| Docker       | prod 用に `Dockerfile` を併記（vite build → `dist` コピー）                                                             | `Dockerfile` (`bundle install`, `puma`)     |

## 7. データ移行 データ移行

* 現行 Excel → CSV 化 → `rails runner db/scripts/import_csv.rb` で初期投入。



## 8. 運用・保守

| 項目     | 方針                                                                      |
| ------ | ----------------------------------------------------------------------- |
| 監視     | Cloudflare Analytics (SPA) + Render メトリクス (API) + UptimeRobot Heartbeat |
| バックアップ | Render 自動 (7 日)＋週次 `pg_dump` を GitHub Releases (暗号化)                    |
| 障害対応   | API 障害: Render Rollback。DB 障害: PITR。または Lightsail DR プランで復旧。            |
| アップデート | Dependabot (& Renovate)→GitHub Actions → Preview → 本番マージ。               |



## 9. 今後フェーズ

1. **画面モック (Figma) & ER 図** を確定。
2. OpenAPI (Swagger) 定義を `rswag` で生成 → フロント型同期。
3. ステージング環境（Render branch deploy & Cloudflare Pages preview）で E2E 試験。



*本 Rev 2.0 は、フロントを React SPA (Vite)、バックエンドを Rails API とした確定要件です。以後の変更はバージョンを increment して管理します。*
