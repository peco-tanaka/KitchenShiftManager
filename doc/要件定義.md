# 勤怠管理システム 要件定義（Rev 3.1 / 2025‑06‑09）

---

## 1. 目的・背景

| 項目   | 内容                                        |
| ---- | ----------------------------------------- |
| 導入背景 | タイムカード＋手入力 Excel で月末 2 日掛かっていた集計業務をゼロにする。 |
| 改善指標 | 月末作業 0 日・打刻漏れ率 1 % 未満（任意）。                |
| 想定規模 | 従業員 ≈ 50 名・1〜複数店舗（飲食）。                    |
| 使用端末 | **PC（メイン）／共有タブレット**（スマホとオフライン打刻は対象外）      |

---

## 2. ステークホルダー & RBAC

| ロール         | 主タスク                             |
| ----------- | -------------------------------- |
| **Staff**   | 出退勤打刻（外出／戻り含む）。自己修正申請は実装しない。     |
| **Manager** | シフト入力、勤怠編集／承認、ユーザ管理、月次 Excel 出力。 |

---

## 3. システム全体構成

```
┌───────────────────────────┐   HTTPS    ┌─────────────────────────────┐
│  React SPA (Vite + TS)    │◀──────────▶│  ASP.NET Core 8 Minimal API │
│  Cloudflare Pages (CDN)   │            │  PostgreSQL (Render)        │
└───────────────────────────┘            │  Excel Export Endpoints     │
                                         └─────────────────────────────┘
```

* **フロント**：React + TypeScript（Vite）を SPA としてビルド → Cloudflare Pages のエッジ CDN で配信（無料枠）。
* **バックエンド**：**C# / .NET 8 ASP.NET Core Minimal API**（`dotnet new webapi --use-minimal-apis`）。JSON を返す REST API。
* **データアクセス**：EF Core 8（Code‑First）。ローカル開発は **SQLite**、本番は **PostgreSQL** に自動スイッチ。
* **DB**：Render Managed PostgreSQL Starter。日次＋PITR 7 日、週次 `pg_dump` を GitHub Private（暗号化）へ保存。
* **認証**：ASP.NET Identity + **JWT**。`access_token` を **httpOnly Cookie** に格納し XSS を緩和。
* **認可**：役割ベース (`[Authorize(Roles="Manager")]`) + Policy ベース（最小権限原則）。
* **通信**：`services.AddCors()` で `https://*.pages.dev` を許可し、`UseCors()` で適用。
* **API スキーマ**：Swashbuckle (`dotnet add package Swashbuckle.AspNetCore`) で Swagger / OpenAPI を自動生成。

---

## 4. 機能要件（MVP）

| #   | 機能                  | 詳細                                                                                                                       |
| --- | ------------------- | ------------------------------------------------------------------------------------------------------------------------ |
| 4‑1 | **打刻**              | 4 桁社員番号＋PW でログイン → ボタン *出勤 / 退勤 / 外出 / 戻り* を登録 (`TimeCards` テーブル)。エンドポイント例 `POST /api/time-cards`。                       |
| 4‑2 | **勤怠一覧 (Web テーブル)** | React で AG‑Grid／Tabulator。インライン編集 → `PUT /api/time-cards/{id}`。編集時 `ChangeLogs` テーブルに before/after を保持。                  |
| 4‑3 | **シフト入力**           | テーブル画面で直接入力 or Excel アップロード (`POST /api/shifts/import`)。社員番号＋日付キーで upsert。                                               |
| 4‑4 | **月次 Excel 出力**     | "DL" ボタン → `GET /api/reports/{yyyy-MM}`。バックエンドで **ClosedXML** によりテンプレート `/Templates/payroll.xlsx` に埋め込みストリーム返却（サーバ保存なし）。 |
| 4‑5 | **ユーザ管理**           | `/api/users` CRUD。パスワードハッシュは ASP.NET Identity (`PasswordHasher`, Bcrypt 12 rounds 相当)。                                   |

### スコープ外

* 給与計算ロジック（Excel 内関数に委任）。
* メール／Slack 通知、スマホ／オフライン打刻、ファイル画像保存。

---

## 5. 非機能要件

| 分類      | 要件                                                                                   |
| ------- | ------------------------------------------------------------------------------------ |
| パフォーマンス | 端末 2 台程度での打刻を想定。API レスポンスは **< 300 ms** を目指す。                                        |
| 可用性     | 稼働率 99 %（6 :00–25 :00）。                                                              |
| セキュリティ  | HTTPS/TLS1.2+、JWT httpOnly Cookie、Identity Bcrypt 12、ASP.NET 授権ポリシー、ログ 3 年保存 (APPI)。 |
| コスト上限   | Render (¥1,100×2) ≒ ¥2,200 + Cloudflare Pages ¥0 → **月 ≤ ¥3,000**。                   |
| 監査      | `ChangeLogs` テーブル（UserId, Before, After, IP, Time）を 3 年保存。                           |

---

## 6. 開発 & デプロイ

| 項目           | フロント (SPA)                                                      | バックエンド (API)                                  |
| ------------ | --------------------------------------------------------------- | --------------------------------------------- |
| **ビルドツール**   | Vite + TypeScript                                               | .NET 8 SDK (`dotnet publish`)                 |
| **スタイリング方針** | **Phase 1:** 素の CSS → **Phase 2:** Tailwind CSS                 | --                                            |
| CI/CD        | GitHub → Cloudflare Pages 自動ビルド                                 | GitHub → Render Auto Deploy (Docker)          |
| ローカル開発       | `vite dev` (5173)                                               | `dotnet watch run` (3000) **＋ SQLite**        |
| 型共有          | `openapi-typescript` で Swagger JSON → `src/types/api.d.ts` 自動生成 | Swashbuckle が `/swagger/v1/swagger.json` を提供  |
| テスト          | React Testing Library / Jest                                    | xUnit + EntityFrameworkCore In‑Memory         |
| Docker       | `Dockerfile` (vite build → `dist`)                              | `Dockerfile` (dotnet publish → minimal image) |

---

## 7. データ移行

* 現行 Excel → CSV 化 → `dotnet run --project tools/CsvImport` で初期投入（Console App）。

---

## 8. 運用・保守

| 項目     | 方針                                                                      |
| ------ | ----------------------------------------------------------------------- |
| 監視     | Cloudflare Analytics (SPA) + Render メトリクス (API) + UptimeRobot Heartbeat |
| バックアップ | Render 自動 (7 日)＋週次 `pg_dump` を GitHub Releases (暗号化)                    |
| 障害対応   | API 障害: Render Rollback / 新イメージ → 旧。DB 障害: PITR ですぐ復旧。                  |
| アップデート | Dependabot (.NET & NPM)→GitHub Actions → Preview → 本番マージ。               |

---

## 9. 今後フェーズ

1. 画面モック (Figma) & ER 図確定。
2. Swagger 生成 (`Swashbuckle`) → TypeScript 型同期 (`openapi-typescript`) 自動化。
3. Render / Cloudflare Pages にステージング環境を構築 → Playwright で E2E テスト実施。

---

*本 Rev 3.1 は **バックエンドを ASP.NET Core Minimal API に確定**したバージョンです。以後変更があれば都度バージョンを更新して管理します。*
