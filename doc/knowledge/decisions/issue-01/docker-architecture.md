# Issue #1 Docker環境構築 設計判断記録

## 概要
Issue #1「開発基盤セットアップ」第2段階のDocker環境構築における主要な設計判断と変更履歴を記録

## 主要な設計判断

### 1. Dockerマルチステージビルド構成

**決定**: 3段階のマルチステージビルド採用

**構成**:
```dockerfile
FROM node:22.17.0-alpine AS build-frontend  # フロントエンドビルド専用
FROM ruby:3.4.4 AS dev                     # 開発環境
FROM ruby:3.4.4-alpine AS prod             # 本番環境
```

**選択理由**:
- **開発効率**: 開発環境でのホットリロードとデバッグツール対応
- **本番最適化**: Alpine Linuxによるイメージサイズ削減
- **ビルド効率**: フロントエンドビルド結果の再利用
- **セキュリティ**: 本番環境での不要なパッケージ除外

**代替案との比較**:
- **単一ステージ**: 開発・本番の要件が異なるため不適切
- **Docker Compose別定義**: ビルド効率とメンテナンス性が劣る

### 2. バージョン固定戦略

**決定**: パッチバージョンまで厳格に固定

**採用バージョン**:
- **Ruby**: `3.4.4` (詳細設計書指定)
- **Node.js**: `22.17.0` (最新LTS)
- **PostgreSQL**: `16` (メジャーバージョンのみ)
- **Bundler**: `2.4.19`

**選択理由**:
- **再現性確保**: 環境間での動作の一貫性
- **セキュリティ**: 既知の脆弱性対応済みバージョン使用
- **Render対応**: デプロイ先での動作保証

**バージョン選択根拠**:
- Ruby 3.4.4: 詳細設計書で明示的に指定
- Node.js 22.17.0: 2024年10月リリースのLTS、安定性と新機能のバランス
- PostgreSQL 16: 最新安定版、パフォーマンス向上

### 3. 開発環境 vs 本番環境の分離戦略

**決定**: docker-compose.dev.yml と docker-compose.prod.yml での完全分離

**開発環境特徴**:
- ボリュームマウントによるホットリロード
- デバッグツール（vim, curl等）の包含
- 詳細なログ出力設定
- ヘルスチェックによる依存関係管理

**本番環境特徴**:
- 静的ファイル内包による単一コンテナ化
- 非rootユーザーでの実行
- 最小限のパッケージ構成
- 環境変数による設定外部化

**選択理由**:
- **開発効率**: 即座の変更反映とデバッグ環境
- **本番安全性**: セキュリティとパフォーマンス最適化
- **デプロイ戦略**: Renderでの単一Web Serviceデプロイ対応

### 4. ヘルスチェック設計

**決定**: 段階的ヘルスチェック実装

**PostgreSQL**:
```yaml
healthcheck:
  test: ["CMD-SHELL", "pg_isready -U dev"]
  interval: 10s
  timeout: 5s
  retries: 5
```

**Rails**:
```dockerfile
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:3000/health || exit 1
```

**選択理由**:
- **依存関係管理**: DB起動完了後にRails起動
- **監視対応**: Renderでの自動復旧対応
- **開発効率**: 起動順序の自動制御

## 変更履歴

### 2025-06-29: Docker環境構築完了
- `docker-compose.dev.yml`: 開発環境用構成作成
- `docker-compose.prod.yml`: 本番環境用構成作成
- `Dockerfile`: マルチステージビルド実装
- `.dockerignore`: 不要ファイル除外設定

### 2025-06-29: バージョン調整
- Ruby: 3.4 → 3.4.4 (パッチバージョン固定)
- Node.js: 20-alpine → 22.17.0-alpine (LTS更新)
- 詳細設計書との完全整合性確保

## 今後の検討事項

### 短期的改善
- Rails health エンドポイントの実装
- 環境変数の統一管理方法
- ログローテーション設定

### 中長期的検討
- Docker Buildxによるマルチプラットフォーム対応
- レイヤーキャッシュ最適化
- セキュリティスキャン自動化
- 本番環境でのマルチステージビルド活用
