# 勤怠管理システム 要件定義 ドラフト

（v0.2 2025‑06‑26 ― ユーザー修正反映）

## 1. 概要

* **対象店舗**：従業員約40名の飲食店（単一店舗）
* **現状**：タイムカード＋Excelで勤怠管理・給与計算
* **目的**：打刻・勤怠情報をシステム化し、既存Excel給与計算シートへ自動転記することで転記ミス削減・集計高速化・3年間のデータ保管を実現
* **開発体制**：個人開発（1名）／生成AIを活用し総工数1週間
* **プラットフォーム**：Front‑end React、Back‑end Rails(API mode)、DB PostgreSQL、**Docker / docker‑compose によるコンテナ化**、ホスティング Render（Docker イメージ・最小課金プラン）

## 2. スコープ

| 区分        | 対象          | 備考                     |
| --------- | ----------- | ---------------------- |
| 打刻        | 出勤／退勤／外出／戻り | 店舗設置PC/タブレットからブラウザ操作   |
| 勤怠実績管理    | ○           | シフトは登録せず実績のみ           |
| 残業時間集計    | ○           | 画面表示のみ（給与計算はExcel側）    |
| Excel連携   | ○           | 固定テンプレートへ転記・DL         |
| 給与計算      | ×           | 既存Excel式で実行            |
| 社員手当管理    | ○           | 固定手当・通勤手当等を入力しExcelへ反映 |
| 休暇・遅刻早退管理 | ×           | 今回除外                   |
| モバイル打刻    | ×           | 今回除外                   |
| 多店舗・多拠点   | ×           | 今回除外（将来的に1店舗追加予定）      |

## 3. 利用者・権限

| ロール    | 主な操作                            | 認証                |
| ------ | ------------------------------- | ----------------- |
| 店長／管理者 | 管理画面: 従業員管理・手当管理・勤怠閲覧・データエクスポート | 社員番号4桁＋PW4桁＋管理フラグ |
| 一般従業員  | 打刻画面: 出退勤・外出・戻りボタン              | 社員番号4桁＋PW4桁       |

## 4. 機能要件

### 4.1 認証

* 社員番号4桁＋パスワード4桁の簡易ログイン
* 新規従業員登録・PWリセットは管理画面のみ
* BCryptによるハッシュ保存

### 4.2 打刻機能

* 打刻ボタン4種（出勤・退勤・外出・戻り）
* **サーバ時刻を秒単位で保存し、正確な打刻時刻を保持**（端末時刻不使用）
* 1日あたりの打刻順制御（例：出勤→外出→戻り→退勤）
* 手修正は管理者のみ可能

### 4.3 勤怠集計・実労働時間計算

* カレンダー／テーブルで日次打刻履歴を閲覧
* **実労働時間**をシステム側で算出し保持

  * 打刻ペア（IN/OUT）を取得し差分を分単位計算
  * `floor(minutes / 15) * 15` で **15 分単位へ切り捨て**
* **時間帯区分**（当日 6:00-17:59 = *昼*、18:00-21:59 = *夜*、22:00-翌 5:59 = *深夜*）ごとに実労働時間を振り分け
* 月次残業時間・所定労働時間・実労働時間を画面表示

### 4.4 Excel出力

* 「月次Excel出力」ボタンで当月分を固定テンプレート（sample.xlsx）へ書き込み
* **出力対象は “実労働時間（15 分切り捨て済み）” のみ**。打刻原票は Excel へは出力しない
* 昼／夜／深夜 区分は下記時間帯で分類して転記

  | 区分    | 時間帯            | Excel 列           |
  | ----- | -------------- | ----------------- |
  | *平日昼*   | 06:00‑17:59    | C, J, Q, X        |
  | *平日夜*   | 18:00‑21:59    | D, K, R, Y        |
  | *深夜*  | 22:00‑05:59    | E/L/S/Z, H/O/V/AC |
  | *日祝昼* | 祝日 06:00‑17:59 | F, M, T, AA       |
  | *日祝夜* | 祝日 18:00‑21:59 | G, N, U, AB       |
* **レイアウト概要（最新）**

  * 1 従業員 = 7 列ブロック（上記列マッピング）
  * 行 0（最上段） : 先頭 3 ブロックに従業員、4 ブロック目に「従業員 TOTAL」
  * 行 1 以降 : 1 行あたり 4 ブロックで折り返し
  * 初期テンプレートには 60 名分の空ブロックを用意
* **配置ロジック**

  1. `active_users` を社員番号昇順で取得
  2. 退職者をスキップし、残りを左上から詰めて配置（アルゴリズム変更なし）
  3. 「従業員 TOTAL」ブロックは固定、数式はテンプレのまま
* **社員手当欄**（正社員手当／通勤手当など）は各ブロックの手当セルへ管理画面で設定された手当金額を転記
* ファイル名：`勤怠_YYYYMM.xlsx`
* ダウンロード対応（ローカル保存運用）

### 4.5 管理機能

* 従業員CRUD
  * 従業員時給金額設定
  * 社員番号・氏名・社員区分・パスワード
  * 社員手当（手当種別・金額・適用開始月）
* 打刻データ検索・修正・削除
* システム設定（締め日《末締め固定》

## 5. 非機能要件

| 項目         | 要求                                                 |
| ---------- | -------------------------------------------------- |
| **性能**     | 同時アクセス最大2セッション／レスポンス <1s                           |
| **UI**     | 日本語、レスポンシブ（PC/タブレット幅600px〜）                        |
| **セキュリティ** | HTTPS強制／パスワードハッシュ／CSRF対策                           |
| **可用性**    | Render **starterプラン**(最小課金)でコールドスタート回避／稼働率>99%想定     |
| **保守性**    | シンプルなReactコンポーネント構成・Rails RESTful API・Docker コンテナ化 |
| **開発環境**   | Docker Desktop / docker-compose でワンコマンド起動          |
| **データ保持**  | DB保存 ≥3年、月次Excelバックアップ                             |
| **ログ**     | アプリログ／打刻監査ログを30日保持                                 |


## 6. リスクと対策

| リスク             | 影響   | 対策                  |
| --------------- | ---- | ------------------- |
| Excelテンプレ連携の複雑さ | 開発遅延 | Day3でPoC／テンプレ構造を固定化 |
| 丸めロジック不一致       | 給与誤差 | 単体テストでシナリオ検証        |
| Render DB容量制限   | 保存不可 | 過去年度CSVアーカイブ＆削除     |

## 7. 将来拡張の展望

* **1店舗追加** を想定した多店舗対応（将来要件）

## 8. コスト試算（2025‑06 時点）

| 区分               | プラン                   | 月額                  | 備考         |
| ---------------- | --------------------- | ------------------- | ---------- |
| Web サービス (Rails) | Render Starter (512 MB) | \$7                 | 常時起動       |
| PostgreSQL       | Render Basic-256mb + 5 GB | \$7.5               | バックアップ 7 日 |
| **合計**           |                       | **\$14.5 ≒ ¥2,300** | 税抜・帯域無料枠内  |

**年額目安**：\$174／年（約 ¥27,600）
※ 独自ドメイン取得（任意）や将来の Sidekiq / Cron 追加は別途。

---