# Issue #5: Excel 出力連携

## 概要
Axlsx でテンプレ書込み、ブロック配置アルゴリズム、`/download` エンドポイントを実装する。

## ゴール
`勤怠_YYYYMM.xlsx` がダウンロードでき、昼／夜／深夜の実働が正しいセルに入るExcel出力機能を構築する。

## スコープ

### 含まれる内容
- [ ] Axlsx gem による Excel 生成
- [ ] 固定テンプレートへの書き込み
- [ ] ブロック配置アルゴリズム
- [ ] 時間帯別実働時間の転記
- [ ] 手当情報の転記
- [ ] ファイルダウンロード機能

### 含まれない内容
- Excel テンプレートの動的生成
- 複数月の一括出力
- Excel ファイルのサーバー保存

## 受入条件

- [ ] 月次Excel出力ボタンでファイルがダウンロードできる
- [ ] 実働時間が時間帯別（昼・夜・深夜）に正しく転記される
- [ ] 従業員が社員番号順で配置される
- [ ] 退職者が適切に除外される
- [ ] 手当情報が各従業員ブロックに転記される
- [ ] 「従業員TOTAL」ブロックが正しく配置される
- [ ] ファイル名が `勤怠_YYYYMM.xlsx` 形式になる

## 技術仕様

### Excel テンプレート構造
```
ブロック配置ルール:
- 1従業員 = 7列ブロック
- 行0: 3ブロック + 1TOTAL ブロック
- 行1以降: 1行あたり4ブロックで折り返し

列マッピング:
- 平日昼 (06:00-17:59): C, J, Q, X
- 平日夜 (18:00-21:59): D, K, R, Y  
- 深夜 (22:00-05:59): E/L/S/Z, H/O/V/AC
- 日祝昼 (祝日 06:00-17:59): F, M, T, AA
- 日祝夜 (祝日 18:00-21:59): G, N, U, AB
```

### 配置アルゴリズム
```ruby
def calculate_position(index)
  if index <= 2
    # 行0の最初の3ブロック
    { row: 0, col_base: get_col_base(index) }
  else
    # 行1以降
    adj = index - 3
    row = 1 + (adj / 4)
    col = adj % 4
    { row: row, col_base: get_col_base(col) }
  end
end
```

## タスク

### Excel ライブラリ設定
- [ ] Axlsx gem の追加
- [ ] Excel生成サービスクラスの作成
- [ ] テンプレートファイルの配置

### ブロック配置ロジック
- [ ] 従業員配置アルゴリズムの実装
- [ ] 列マッピング定義
- [ ] ブロック座標計算ロジック
- [ ] 従業員TOTAL ブロック固定配置

### データ集計・転記
- [ ] 月次勤怠データ集計
- [ ] 時間帯別実働時間計算
- [ ] 祝日判定（holidays-jp）
- [ ] 手当データ取得・転記
- [ ] Excel セルへの書き込み処理

### API エンドポイント
- [ ] GET /api/admin/excel/download
- [ ] 月パラメータ対応
- [ ] エラーハンドリング
- [ ] ファイル送信処理

### Excel 生成サービス
- [ ] ExcelGeneratorService クラス
- [ ] テンプレート読み込み処理
- [ ] セル書き込み処理
- [ ] ファイル生成・保存処理

### フロントエンド実装
- [ ] Excel ダウンロードボタン
- [ ] 月選択UI
- [ ] ダウンロード進行状況表示
- [ ] エラー通知

### データ処理最適化
- [ ] 大量データ処理の最適化
- [ ] メモリ使用量の最適化
- [ ] 処理時間の短縮

### テンプレート管理
- [ ] sample_v202506.xlsx の配置
- [ ] テンプレート検証処理
- [ ] バージョン管理対応

### エラーハンドリング
- [ ] データ不整合時の処理
- [ ] Excel生成失敗時の処理
- [ ] ファイルサイズ制限

### テスト
- [ ] ブロック配置ロジックのテスト
- [ ] Excel生成のテスト
- [ ] データ転記の正確性テスト
- [ ] ダウンロード機能のテスト

## 参考資料
- `/doc/詳細設計.md` の「Excel 連携詳細」
- `/doc/要件定義.md` の「Excel出力」
- sample_v202506.xlsx テンプレートファイル
