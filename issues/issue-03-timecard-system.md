# Issue #3: 打刻 & 勤怠集計

## 概要
`punches` API（IN / OUT / BREAK）、15 分切り捨てロジック、月次集計エンドポイント、打刻画面 (React) を実装する。

## ゴール
出退勤ボタン → API → DB 保存 ➜ `/api/attendance?month=` が昼・夜・深夜別実働分を返すシステムを構築する。

## スコープ

### 含まれる内容
- [ ] 打刻API（出勤・退勤・外出・戻り）
- [ ] 打刻時刻の正確な記録（サーバー時刻）
- [ ] 1日の打刻順序制御
- [ ] 15分切り捨てロジック
- [ ] 時間帯区分（昼・夜・深夜）別集計
- [ ] 月次勤怠集計API
- [ ] 打刻画面UI
- [ ] 勤怠閲覧画面

### 含まれない内容
- 打刻の手修正機能（Issue #4で実装）
- Excel出力（Issue #5で実装）
- 残業時間の詳細計算

## 受入条件

- [ ] 打刻ボタンで正確な時刻が記録される
- [ ] 打刻順序が正しく制御される（出勤→外出→戻り→退勤）
- [ ] 15分切り捨てロジックが正しく動作する
- [ ] 時間帯区分（昼6:00-17:59、夜18:00-21:59、深夜22:00-5:59）で集計される
- [ ] 月次集計APIが正しい実働時間を返す
- [ ] 打刻画面で現在の状態が分かる
- [ ] 勤怠閲覧画面で日次・月次データが確認できる

## 技術仕様

### データベース
- punches テーブル: 打刻原本ログ
- フィールド: user_id, punched_at, punch_type, device_id, ip_address

### 打刻種別
```ruby
enum punch_type: { 
  in: 0,           # 出勤
  out: 1,          # 退勤
  break_start: 2,  # 外出
  break_end: 3     # 戻り
}
```

### 時間帯区分
- 昼: 06:00-17:59
- 夜: 18:00-21:59  
- 深夜: 22:00-05:59

### 切り捨てロジック
```ruby
# 15分単位切り捨て
def round_down_to_15min(minutes)
  (minutes / 15) * 15
end
```

## タスク

### データベース設計
- [ ] punches テーブルのマイグレーション
- [ ] Punch モデルの実装
- [ ] User - Punch の関連定義

### 打刻API実装
- [ ] POST /api/punches
- [ ] 打刻種別バリデーション
- [ ] 打刻順序制御ロジック
- [ ] サーバー時刻での記録
- [ ] IP アドレス・デバイス情報の記録

### 勤怠集計ロジック
- [ ] 日次実働時間計算
- [ ] 15分切り捨て処理
- [ ] 時間帯区分別集計
- [ ] 月次集計処理
- [ ] 祝日判定（holidays-jp gem）

### 勤怠閲覧API
- [ ] GET /api/punches (個人の打刻履歴)
- [ ] GET /api/attendance (月次勤怠集計)
- [ ] 管理者用: 全従業員の勤怠閲覧

### フロントエンド実装
- [ ] 打刻画面の実装
  - [ ] 現在の打刻状態表示
  - [ ] 打刻ボタン（4種類）
  - [ ] 打刻履歴表示
- [ ] 勤怠閲覧画面の実装
  - [ ] カレンダー表示
  - [ ] 日次・月次集計表示
  - [ ] 時間帯別実働時間表示

### 状態管理
- [ ] React Query での API状態管理
- [ ] 打刻状態のリアルタイム更新
- [ ] エラーハンドリング

### バリデーション & エラー処理
- [ ] 不正な打刻順序の検出
- [ ] 重複打刻の防止
- [ ] フロントエンド側バリデーション

### テスト
- [ ] 打刻APIのテスト
- [ ] 勤怠集計ロジックのテスト
- [ ] 切り捨てロジックのテスト
- [ ] 時間帯区分のテスト
- [ ] UI コンポーネントのテスト

## 参考資料
- `/doc/詳細設計.md` の「DB設計」punches テーブル
- `/doc/詳細設計.md` の「打刻丸めアルゴリズム」
- `/doc/要件定義.md` の「打刻機能」
- `/doc/要件定義.md` の「勤怠集計・実労働時間計算」
